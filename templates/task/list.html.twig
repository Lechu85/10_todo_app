{% extends 'base.html.twig' %}

{% block title %}Hello TaskController!{% endblock %}

{% block body %}


<div class="b-example-divider b-example-vr"></div>


<div class="d-flex flex-column align-items-stretch flex-shrink-0 overflow-auto" style="width: 780px; padding: 15px;">

    {# read and display several types of flash messages #}
    {% for label, messages in app.flashes(['success', 'warning']) %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endfor %}


    <div class="border-bottom d-flex align-items-center p-3 mb-2">
        <div class="fs-5 fw-semibold me-auto">Lista zadań</div>

        <a href="{{ path('app_task_new') }}" class="btn btn-primary active me-1" aria-current="page">Nowe zadanie</a>

        <div class="btn-group">
            <a href="{{ path('app_task_category_new') }}" class="btn btn-primary">Nowa kategoria</a>
            <a href="{{ path('app_task_category_show_list') }}" class="btn btn-primary">Lista kategorii</a>
        </div>
    </div>

    {{ form_start(form_task_search) }}
    {# <form action="{{ path('app_task_search') }}" method="get"> #}
    {# , {'action': path('app_task_search'), 'method': 'get'} #}
    <div class="card">

        <div class="card-header">
            Znajdź zadanie
        </div>

        <div class="card-body" style="background: #f7f7f7;">

            <div class="input-group mb-3">
                <div class="input-group-text" id="addDescriptionWrapper">
                    <input class="form-check-input mt-0" type="checkbox" value="1" name="search_in_description" id="search_in_description" {% if search_in_description == 1 %}checked{% endif %} aria-label="Szukaj również w opisie">
                    <label for="search_in_description"><span class="small ms-1">+ Opis</span></label>
                </div>
                {# <input type="text" class="form-control" aria-label="Text input with checkbox"> #}
                {{ form_widget(form_task_search.title, {'attr': {'placeholder':'Znajdź zadanie', 'value': search_phraze, 'name':'search_phraze', 'aria-label': 'Task title','aria-describedby': 'button-addon2' }}) }}

                <button type="submit" class="btn btn-outline-primary" id="button-addon2">Szukaj</button>
                <button class="btn btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvancedSearch" aria-expanded="false" aria-controls="collapseAdvancedSearch">Zaawansowane</button>
            </div>

            {% if search_badge_list != '' %}
                <div>
                    {{ search_badge_list|raw }}
               </div>
            {% endif %}


            <div class="collapse mt-3" id="collapseAdvancedSearch">

                <div class="row">
                    <div class="col">
                      {#   {{ form_row(form_task_search.dueDateFrom, {'attr': {'value': '2024-11-24 12:00'}}) }}#}
                        {{ form_row(form_task_search.dueDate.From) }}
                    </div>
                    <div class="col">
                        {{ form_row(form_task_search.dueDate.To) }}
                    </div>
                </div>


                <div class="row">
                    <div class="col">
                        {{ form_row(form_task_search.createdAt.From) }}
                    </div>
                    <div class="col">
                        {{ form_row(form_task_search.createdAt.To) }}
                    </div>
                </div>


                <div class="row">
                    <div class="col">
                        {{ form_row(form_task_search.doneAt.From) }}
                    </div>
                    <div class="col">
                        {{ form_row(form_task_search.doneAt.To) }}
                    </div>
                </div>

                {{ form_rest(form_task_search) }}


            </div>

        </div>
    </div>
    {{ form_end(form_task_search) }}


    <div class="list-group list-group-flush border-bottom scrollarea">

        <form action="{{ path('app_task_group_action') }}" method="post">
            <input type="hidden" name="group_action_name" id="group_action_name" value="">

            <table class="table table-striped table-hover table-bordered mt-2">
                <tr>
                    <th>&nbsp;</th>
                    <th>Id</th>
                    <th>Tytuł zadania</th>
                    <th>Termin</th>
                    <th>Akcja</th>
                </tr>
                {% for task in tasks %}
                    <tr>
                        <td><input type="checkbox" name="task[]" value="{{ task.id }}"></td>
                        <td>{{ task.id }}</td>
                        <td>
                            <a href="{{ path('app_task_show', {'id': task.id }) }}"><b>{{ task.title }}</b></a>
                            {% if task.prioryty is not empty %}
                            <span class="badge text-bg-{{ prioryty_bg_array[task.prioryty] }}">{{ prioryty_array[task.prioryty] }}</span>
                            {% endif %}
                        </td>
                        <td>{{ task.dueDate|date("Y-m-d") }}</td>
                        <td>
                            <div class="dropdown">
                                <a class="btn btn-light btn-sm dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="{{ asset('img/ico_action.svg') }}" alt="" class="action_ico">
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{{ path('app_task_show', {id: task.id}) }}">Podglądnij</a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_task_edit', {id: task.id}) }}">Edytuj</a></li>
                                    <li><a class="dropdown-item text-success" href="{{ path('app_task_group_action', {id: task.id, group_action_name: 'done'}) }}"">Wykonane</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger confirmDelete" href="{{ path('app_task_remove', {id: task.id}) }}">Usuń</a></li>
                                </ul>
                            </div>

                        </td>
                    </tr>
                {% endfor %}
            </table>

            {% if tasks|length == 0 %}
                <div class="alert alert-primary mt-2" role="alert">
                    {% if search_badge_list is not empty %}
                        Brak zadań spełniających podane kryteria.
                        {# todo Jeżeli podano kategorie to przekierowujemy na strona z tąkategoriuą #}

                        <a class="btn btn-danger btn-sm" href="{{ path('app_task_show_list') }}" >Wyczyść filtr</a>

                    {% else %}
                        Brak zadań.
                    {% endif %}
                </div>
            {% else  %}

                <div class="card mt-2">
                    <div class="card-header">
                        Znaleziono zadań: {{ tasks|length }}
                    </div>
                    <div class="card-body">
                        <button type="submit" id="btn_group_action_delete" class="btn btn-danger confirmDelete">Usuń</button>
                        <button type="submit" id="btn_group_action_done" class="btn btn-primary">Wykonane</button>
                    </div>
                </div>

            {% endif %}


           {# <button type="button" class="btn btn-primary confirmDelete">live toast</button> #}

            <div class="toast-container position-fixed top-50 start-50 translate-middle p-3">
                {#
                <div id="liveToast" class="toast align-items-center text-bg-success bg-opacity-75" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            Hello, world! This is a toast message 2.
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
                #}

                <div id="confirmDeleteToast" class="toast bg-white border-1" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-body">
                        Usunąć wybrane pozycje?
                        <div class="mt-2 pt-2 border-top">
                            <button type="button" class="btn btn-danger btn-sm" onClick="JavaScript: function(event) {return true;}">Usuń</button>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="toast">Anuluj</button>
                        </div>
                    </div>
                </div>


            </div>

            <script>

                const confirmBtn = document.querySelectorAll('.confirmDelete')
                const confirmAlertWrapper = document.getElementById('confirmDeleteToast')

                confirmBtn.forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        const toast = new bootstrap.Toast(confirmAlertWrapper)

                        event.preventDefault();

                        toast.show()

                    })
                })

            </script>

        </form>
    </div>






</div>










<script>
    /*document.querySelector('.confirm-delete').addEventListener('click', event => {
        return confirm('Are you sure to delete?');

    });*/

    {# info ukrywamy pole checkbox +Opis dla zaawansowanej wyszukiwarki #}

    const myCollapsible = document.getElementById('collapseAdvancedSearch')

    {# question - czy tutaj zasaday SOLID zostałą złamana? jedna funkcja chowa i ukrywa? Zrobić dwie funkcje? #}
    function toggleAddDescriptionBtn(hideOrShow){
        btn_wrapper = document.getElementById('addDescriptionWrapper')
        btn_wrapper.style.display = hideOrShow
        btn_wrapper.querySelector('input[type="checkbox"]').checked = false
    }

    myCollapsible.addEventListener('hide.bs.collapse', event => {
        toggleAddDescriptionBtn('flex')
    })

    myCollapsible.addEventListener('show.bs.collapse', event => {
        toggleAddDescriptionBtn('none')
    })


    {# info wysylamy grupowe akcje #}
    function doGroupAction(event, type_action) {

        const task_checkboxes = document.querySelectorAll('input[name="task[]"]:checked')

        if (task_checkboxes.length === 0) {
            alert('Zaznacz przynajmniej jedno zadanie')
            event.preventDefault()

        } else {
            document.getElementById('group_action_name').value = type_action
        }

    }

    document.getElementById('btn_group_action_delete').addEventListener('click', function(event) {
        doGroupAction(event, 'delete')
    });
    document.getElementById('btn_group_action_done').addEventListener('click', function(event) {
        doGroupAction(event, 'done')
    });
</script>

{% endblock %}
